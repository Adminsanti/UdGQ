<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_udg_q.ObjectiuUtils</api_name>
        <client_callable>false</client_callable>
        <description/>
        <name>ObjectiuUtils</name>
        <script><![CDATA[var ObjectiuUtils = Class.create();
ObjectiuUtils.prototype = {
	initialize: function(objectiu) {
		if (objectiu) this._objectiu=objectiu;
		},
	
	actualitzaAssoliment: function () {
		new x_udg_q.log("ObjectiuUtils.actualitzaAssoliment "+this._objectiu.number);
		var grObjectiu = new GlideRecord ('x_udg_q_objectiumillora');
		grObjectiu.get (this._objectiu);
		grObjectiu.accions=this.getAccions(this._objectiu);
		grObjectiu.assoliment = this.getAssoliment(this._objectiu);
		
		if (grObjectiu.actiu == true) grObjectiu.state=this.getEstatPerAssoliment();
			
		grObjectiu.update();
	},
	
	getAccions: function(objectiu_id) {
		new x_udg_q.log("ObjectiuUtils.getAccions "+objectiu_id.number);
		var grM2m = new GlideRecord ('x_udg_q_m2m_accions_objectius');
		grM2m.addQuery('objectiu_millora', objectiu_id);
		grM2m.addQuery("accio_millora.state!=-5"); //Les accions en Draft no compten
		grM2m.query();
		return grM2m.getRowCount();
	},
	
	getAssoliment: function(objectiu_id) {
		new x_udg_q.log("ObjectiuUtils.getAssoliment "+objectiu_id.number);
		//Retorna l'assoliment d'un objectiu a partir de totes les accions que hi contribueixen
		var grObjectiu = new GlideRecord ('x_udg_q_objectiumillora');
		grObjectiu.get (objectiu_id);
		
		if (grObjectiu.state==-5 || grObjectiu.state==5) {
			new x_udg_q.log("ObjectiuUtils.actualitzaAssoliment: L'assoliment que ja té: "+grObjectiu.number);
			return grObjectiu.assoliment;
		}
		var assoliment=0;
		var ponderacions=0;
		var grM2m = new GlideRecord ('x_udg_q_m2m_accions_objectius');
		grM2m.addQuery('objectiu_millora', grObjectiu.sys_id);
		grM2m.addQuery("accio_millora.state!=-5"); //Les accions en Draft no compten
		grM2m.query();
		while (grM2m.next()){ //Per cada action
			if (grM2m.contribucio >0 && grM2m.accio_millora.state!=-5) { //L'accio ha de contribució>0 i no ser esborrany
				ponderacions += grM2m.contribucio;
				assoliment += (grM2m.accio_millora.percentatge*grM2m.contribucio);
			}
		}
		if (ponderacions>0) return (assoliment/ponderacions);
			else return 0;
	},
	
	getEstatPerAssoliment: function (assoliment) {
		if (assoliment <= 0)
			return 1;
		if (assoliment >= 100)
			return 3;
		return 2;
	},
	
	responsableObjectiuDefecte: function () {
		var SGQpref=gs.getUser().getPreference('qualitat.sgqActual');
		var gr = new GlideRecord ('x_udg_q_sgq');
		gr.get("sys_id="+SGQpref);
		return gr.propietari;
	},
	
	setAllResponsables: function (funcio) {
		var gr = new GlideRecord ('x_udg_q_objectiumillora');
		gr.addQuery('funcio', funcio);
		gr.addQuery('state=-5'); //No s'actualitzan Esborranys
		grObj.query();
		new x_udg_q.log(funcio.sgq.codi+" ObjectiuUtils.setAllResponsables busca objectius amb responsable: "+ funcio.nom);
		while (gr.next()) {
			new x_udg_q.log(gr.number +" ObjectiuUtils.setAllResponsables actualitza ("+funcio.nom +") " + gr.assigned_to.name +" -> "+ funcio.usuari.name);
			grObj.assigned_to=funcio.usuari;
			grObj.update();
		}
	},
		
	type: 'ObjectiuUtils'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>adminsanti</sys_created_by>
        <sys_created_on>2018-11-06 16:28:53</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>cfb376aedbe923009fd1f57eaf9619e4</sys_id>
        <sys_mod_count>71</sys_mod_count>
        <sys_name>ObjectiuUtils</sys_name>
        <sys_package display_value="UdG Qualitat" source="x_udg_q">29219b8737df5f001acdf01643990e33</sys_package>
        <sys_policy>read</sys_policy>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="UdG Qualitat">29219b8737df5f001acdf01643990e33</sys_scope>
        <sys_update_name>sys_script_include_cfb376aedbe923009fd1f57eaf9619e4</sys_update_name>
        <sys_updated_by>adminsanti</sys_updated_by>
        <sys_updated_on>2018-11-22 15:39:14</sys_updated_on>
    </sys_script_include>
</record_update>
