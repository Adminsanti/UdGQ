<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_udg_q.ProcesSGQ</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <name>ProcesSGQ</name>
        <script><![CDATA[var ProcesSGQ = Class.create();
ProcesSGQ.prototype = {
    initialize: function() {},

    nouNom: function(grProces) {
        return 'P' + grProces.num + grProces.sgq.codi + '. ' + grProces.titol;
    },

    LlistaFills: function(idProcesPare) {
        var llistaF = [];
        var grProc = new GlideRecord('x_udg_q_proces');

        grProc.addQuery('pare', idProcesPare);
        grProc.query();
        while (grProc.next()) {
            llistaF.push(grProc.sys_id);
        }
        return llistaF;
    },

    LlistaFillsCodiSGQ: function(idProcesPare) {
        var llistaF = [];
        var grProc = new GlideRecord('x_udg_q_proces');
        grProc.setWorkflow(false); //Així no s'executa la query rule -- ATENCIÓ!!!
        grProc.addQuery('pare', idProcesPare);
        grProc.query();
        while (grProc.next()) {
            llistaF.push(grProc.sgq.codi);
        }
        return llistaF;
    },

    creaFillsInexistents: function(grPare) {
        var llegatsaSGQ = grPare.llegata.split(",");
        for (i = 0; i < llegatsaSGQ.length; i++) { //Bucle SGQ llegats
            var grF = new GlideRecord('x_udg_q_proces');
            grF.setWorkflow(false); //Així no s'executa la query rule i podem veure'ls tots -- ATENCIÓ!!!
            grF.addQuery('pare', grPare.sys_id);
            grF.addQuery('sgq', llegatsaSGQ[i]);
            grF.query();
            if (!grF.next()) {
				gs.addInfoMessage(grPare.num+" cal crear fill a sgq "+llegatsaSGQ[i]);
				this.creaFill(grPare, llegatsaSGQ[i]); //si el fill no existeix el creem mitg buit
			} else {
				gs.addInfoMessage(grPare.num+" ja té fill a sgq "+llegatsaSGQ[i]+ " amb nom "+grF.nom+" i sys_id "+grF.sys_id );
			}
            if (grF.next()) { //mai hauria d'entrar en aquest segon next(), vol dir que té dos fills en el mateix SGQ
                gs.addErrorMessage('Atenció ' + grPare.nom + 'te més d\'un fill al sgq ' + llegats[i]);
            }
        }
    },

    sincroTotsFills: function(grPare) { //sincronitza tots els fills
        var grFill = new GlideRecord('x_udg_q_proces');
        grFill.addQuery('pare', grPare.sys_id);
        grFill.setWorkflow(false); //Així no s'executa la query rule i podem veure'ls tots -- ATENCIÓ!!!
        grFill.query();
        while (grFill.next()) {
            this.sincronitzaFill(grPare, grFill);
        }
    },

    creaFill: function(grPare, sgqFill) {
        var grFill = new GlideRecord('x_udg_q_proces');
        grFill.initialize();
        grFill.pare = grPare.sys_id;
        grFill.actiu = true;
        grFill.tipus = 'Llegat';
        grFill.sgq = sgqFill;
		grFill.num=grPare.num;
		grFill.titol=grPare.titol;
		grFill.nom=this.nouNom(grFill);
		grFill.propietari = grFill.sgq.propietari;
        grFill.responsable = grFill.sgq.responsable;
		grFill.update();
        //this.sincronitzaFill(grPare, grFill); //En principi NO cal
    },

    sincronitzaFill: function(grPare, grFill) { //No estic segur que funcioni
        var llegats = grPare.llegata.split(",");
        if (llegats.indexOf(grFill.sys_id) !=0) { //És a la llista de llegats
            grFill.actiu = true;
        } else {
            grFill.actiu = false;
        }
        if (grFill.actiu) {
            if (grFill.tipus == 'Llegat') {
                grFill.nom = grPare.nom;
                grFill.num = grPare.num;
                grFill.titol = grPare.titol;
                grFill.document = grPare.document;
                grFill.versio = grPare.versio;
                grFill.sincronitzat = true;
				grFill.dimensiosgiqaqu=grPare.dimensiosgiqaqu;
				grFill.criteriaudit=grPare.criteriaudit;
            }
            if (grFill.tipus == 'Adaptat') {
                grFill.nom = grPare.nom;
                grFill.num = grPare.num;
                grFill.titol = grPare.titol;
				grFill.dimensiosgiqaqu=grPare.dimensiosgiqaqu;
				grFill.criteriaudit=grPare.criteriaudit;
                //com dessincronitzem? ****************************************
            }
        }
        grFill.update();
    },

    actualitzaTot: function(proces_sys_id) {
        //Actualitza el procés en vase a les versions
        var grProc = new GlideRecord('x_udg_q_proces');
        var grVersio = new GlideRecord('x_udg_q_versioproces');
        grProc.get(proces_sys_id);
        grVersio.addQuery('proces', proces_sys_id);
        grVersio.addQuery('state', "=", 2); //Versió vigent
        grVersio.query();
        if (grVersio.next()) {
            grProc.document = grVersio.document;
			grProc.fitxerdocument= grVersio.fitxer;
            grProc.versio = grVersio.versio;
			grProc.update();
        }  else { //No hi ha versió vigent
			grProc.document = "";
			grProc.fitxerdocument= "";
            grProc.versio = "";
			grProc.update();
		}
    },

    getHTMLDocument: function(sys_id) {
        if (sys_id && sys_id != "") {
            var html = '<p>';
            html += '<iframe src=\"$viewer.do?sysparm_stack=no&amp;sysparm_sys_id=';
            html += sys_id + '\" width=\"100%\" height=\"700px\">';
            html += '</p>';
            html += '<p>&nbsp;</p>';
            return html;
        } else {
            return '<P><H2>No hi ha document</H2></P>';
        }
        /* //Aquest és el codi de quan era insertat com imatge
        grproc.flux = '<p><img style=\"align: baseline;\" title=\"\" src=\"sys_attachment.do?sys_id=' + attachment_sys_id + '\" alt=\"\" align=\"baseline\" border=\"\" hspace=\"\" vspace=\"\" \/></p>';  */
    },

    emplenaDocumentVersioProces: function(sys_id_versioproces, sys_id_attachment) {
        var grVProc = new GlideRecord('x_udg_q_versioproces');
        grVProc.get(sys_id_versioproces);
        grVProc.document = this.getHTMLDocument(sys_id_attachment);
		grVProc.fitxer=sys_id_attachment;
        grVProc.update();
        if (grVProc.state == 2 && grVProc.actiu) {
            var grProc = new GlideRecord('x_udg_q_proces');
            grProc.get(grVProc.proces);
			grProc.fitxerdocument=sys_id_attachment;
            grProc.document = this.getHTMLDocument(sys_id_attachment);
            grProc.update();
        }
    },

    regeneraVersioProces: function(grVersioProces) {
        var grAttachment = new GlideRecord('sys_attachment');
        grAttachment.addQuery('table_sys_id', grVersioProces.sys_id);
        grAttachment.query();
        if (grAttachment.next()) {
            this.emplenaDocumentVersioProces(grVersioProces.sys_id, grAttachment.sys_id);
        }
    },

    ActualitzaMapaProcessos: function(sgq_sys_id) {
        var grproc = new GlideRecord('x_udg_q_proces');
        var html = "<table border=1px><tr style=\"background-color: #b86767;\">Processos propis</tr>";
        grproc.addQuery('sgq', sgq_sys_id);
		grproc.addQuery('actiu', 'true');
        grproc.orderBy('nom');
        grproc.query();

        while (grproc.next()) {
            html += "<tr ";
            html += "style=\"background-color: #f2c2c2;";
            html += "\"><td>" + grproc.nom + "</td>";
            if (grproc.pare) {
                html += "<td>Transversal</td>";
            } else {
                html += "<td>Propi</td>";
            }
            html += "</tr>";
        }
        html += "</table>";

        var grsgq = new GlideRecord('x_udg_q_sgq');
        grsgq.get('sys_id', sgq_sys_id);
        grsgq.mapa = html;
        grsgq.update();
        return html;
    },

    type: 'ProcesSGQ'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>adminsanti</sys_created_by>
        <sys_created_on>2018-10-05 07:29:45</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>e71e4450db8def009fd1f57eaf961924</sys_id>
        <sys_mod_count>90</sys_mod_count>
        <sys_name>ProcesSGQ</sys_name>
        <sys_package display_value="UdG Qualitat" source="x_udg_q">29219b8737df5f001acdf01643990e33</sys_package>
        <sys_policy>read</sys_policy>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="UdG Qualitat">29219b8737df5f001acdf01643990e33</sys_scope>
        <sys_update_name>sys_script_include_e71e4450db8def009fd1f57eaf961924</sys_update_name>
        <sys_updated_by>adminsanti</sys_updated_by>
        <sys_updated_on>2021-03-24 10:02:43</sys_updated_on>
    </sys_script_include>
</record_update>
